<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
    <title>模联完善资料页面</title>
    <link rel="stylesheet" href="../css/mui.min.css"/>
    <link rel="stylesheet" href="../css/mui_popover.css"/>
    <link rel="stylesheet" href="../css/base.css"/>
    <link rel="stylesheet" href="../css/header.css"/>
    <link rel="stylesheet" href="../css/addData.css"/>
    <link rel="stylesheet" href="../css/sweetalert2.css"/>
    <style>
        #loading{
            display: none;
        }
    </style>
</head>
<body>
<div id="loading">
    <img src="../img/login.gif" alt=""/>
    <div>请等待，正在加载...</div>
</div>
<div class="layer">
    <header>
        <i onclick="back()"></i>
        <h3>完善资料</h3>
        <em onclick="location.href='login.html'" class="jump">跳过</em>
    </header>
    <div class="main_content">
       <div class="name clearfix">
           <span class="f_left">技工姓名：</span>
           <input type="text" placeholder="请输入姓名" />
       </div>
        <div class="experience clearfix" onclick="location.href='./addData_work.html'">
            <span class="f_left">工作经历：</span>
            <em>+ 添加工作经历</em>
        </div>
        <div class="type clearfix">
            <span class="f_left">技工工种：</span>
            <a href="#middlePopover" class="type_choose">+ 请选择工种名称</a>
            <div id="middlePopover" class="mui-popover">
                <div class="mui-card">
                    <p>请选择技术工种</p>
                    <ul class="mui-table-view mui-table-view-radio">
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                普通车床
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                数控车床
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                数控加工中心
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                刨床
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                线切割
                            </a>
                        </li><li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                钻床
                            </a>
                        </li><li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                钳工
                            </a>
                        </li><li class="mui-table-view-cell">
                            <a class="mui-navigate-right">
                                装配工
                            </a>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="work_year clearfix">
            <span class="f_left">工作年限：</span>
            <a href="#middlePopover1" class="work_choose">+ 请选择工作年限</a>
            <div id="middlePopover1" class="mui-popover">
                        <p>请选择工作年限</p>
                        <ul class="mui-table-view mui-table-view-radio word_year">
                            <li class="mui-table-view-cell" >
                                <a class="mui-navigate-right">
                                    0~1年
                                </a>
                            </li>
                            <li class="mui-table-view-cell">
                                <a class="mui-navigate-right">
                                    1~3年
                                </a>
                            </li>
                            <li class="mui-table-view-cell">
                                <a class="mui-navigate-right">
                                    3~5年
                                </a>
                            </li>
                            <li class="mui-table-view-cell">
                                <a class="mui-navigate-right">
                                    5~10年
                                </a>
                            </li>
                            <li class="mui-table-view-cell">
                                <a class="mui-navigate-right">
                                    10年以上
                                </a>
                            </li>
                     </ul>

            </div>
        </div>
        <div class="ID_message clearfix">
            <span class="f_left">技工身份信息：</span>
            <input type="number" id="Idcard" placeholder="请填写技工身份证号码"/>
        </div>
        <div class="Id_photo clearfix">
            <span class="f_left">身份证信息：</span>
            <em>请上传您的身份证照片</em>
            <div class="against f_right">
                <div class="against_box">
                    <input type="file" id="against" accept="image/*" capture="camera" />
                </div>

                <em>身份证国徽面</em>
            </div>
            <div class="open f_right">
                <div class="open_box">
                    <input type="file" id="just" accept="image/*" capture="camera"/>
                </div>
            <em>身份证照片面</em>
            </div>

        </div>

        <div class="address clearfix">
            <span class="f_left">居住地址：</span>
            <input type="text" placeholder="请填写常用地址" />
        </div>
        <div class="phone clearfix">
            <span class="f_left">联系电话：</span>
            <input type="number"  placeholder="请输入电话号码" class="f_left phone_number"/>
            <input type="number" placeholder="请输入验证码" class="f_right ver_number"/>
           <em class="gain" onclick="getcode()">请输入验证码</em>
        </div>

        <div class="introduce clearfix">
            <span class="f_left">自我介绍：</span>
            <textarea placeholder="请输入自我介绍"></textarea>
        </div>
    </div>
    <div class="add_box">
        <button class="add_data">保存资料</button>
    </div>

</div>

</body>
<script src="../js/common/x_rem.js"></script>
<script src="../js/common/mui.min.js"></script>
<script src="../js/common/jquery.js"></script>
<script src="../js/common/base.js"></script>

<script src="../js/common/back.js"></script>
<script src="../js/common/sweetalert2.js"></script>
<script src="../js/common/fastclick.js"> </script>
<script>
    //fastclick 的使用
    FastClick.attach(document.body);
        /*加个标记 判断是否隐藏 em*/
        var url=location.href.split("?")[1];
        console.log(url);
    if(url!==undefined){
        $(".jump").hide();
        }
        //工作经验
       var companyName=localStorage.getItem("companyName");
        if(companyName){
            $(".experience>em").text("已添加完成");
            $(".experience>em").css("color","#333");
        }
        mui.init({
        swipeBack: true //启用右滑关闭功能
    });

    mui('.mui-scroll-wrapper').scroll();
    mui('body').on('shown', '.mui-popover', function(e) {
        window.event? window.event.cancelBubble = true : e.stopPropagation();
        //console.log('shown', e.detail.id);//detail为当前popover元素
    });
    mui('body').on('hidden', '.mui-popover', function(e) {
        window.event? window.event.cancelBubble = true : e.stopPropagation();
        //console.log('hidden', e.detail.id);//detail为当前popover元素
    });
    //采用自定义属性选择单选框吧
    //var info = document.getElementById("info");
    document.querySelector('.mui-table-view.mui-table-view-radio').addEventListener('selected',function(e){
        console.log("工作类型为：" + e.detail.el.innerText);
        console.log(e.detail.el);
        document.querySelector(".type_choose").innerText=e.detail.el.innerText;
        document.querySelector(".type_choose").style.color="#333";
        document.querySelector("#middlePopover").style.display="none";
        document.querySelector(".mui-backdrop").style.display="none";
        window.event? window.event.cancelBubble = true : e.stopPropagation();
       /* alert(1);*/
    });
    document.querySelector('.mui-table-view.word_year').addEventListener('selected',function(e1){
        window.event? window.event.cancelBubble = true : e.stopPropagation();
        console.log("工作年限为：" + e1.detail.el.innerText);
        document.querySelector(".work_choose").innerText= e1.detail.el.innerText;
        document.querySelector(".work_choose").style.color="#333";
        document.querySelector("#middlePopover1").style.display="none";
        document.querySelector(".mui-backdrop").style.display="none";
       /* alert(1);*/
    });

    //验证身份证 电话不为空 11位的函数都在base.js里面了
  //图片预览 国徽面设置完毕  封装
    document.querySelector("#against").onchange=function () {
        var file=document.querySelector("#against").files;

        html5Reader(file,".against_box");
        //console.log(base64IdCardBack);
    }
    document.querySelector("#just").onchange=function () {
        var file=document.querySelector("#just").files;

        html5Reader(file,".open_box");
      // console.log(base64IdCardFront);
    }
    function html5Reader(file,ele){
        //var file = file.files[0];
        var reader = new FileReader();
       // reader.readAsDataURL(file);
        reader.readAsDataURL(file[0]);
        reader.onload = function(e){
            var pic = document.querySelector(ele);
            pic.style.backgroundImage="url("+reader.result+")";
           var des=reader.result;
           // console.log(des);
        }
    }


        $(".mui-navigate-right").click(function (event) {
                event.stopPropagation();

        })
        //点击保存资料的时候可以获取所有的信息
        $(".add_data").click(function () {
           var base64IdCardBack=$(".against_box").css('backgroundImage').replace('url(','').replace(')','');
            //console.log(base64IdCardBack);
            if(base64IdCardBack.replace(/\"/g,"") =="http://localhost:63342/MU/img/against.png"){
                base64IdCardBack="";
            }else{
                base64IdCardBack=base64IdCardBack;
            }
           // console.log(base64IdCardBack);
            var base64IdCardFront=$(".open_box").css('backgroundImage').replace('url(','').replace(')','');
            //console.log(base64IdCardFront);
            if(base64IdCardFront.replace(/\"/g,"")=="http://localhost:63342/MU/img/just.jpg"){
                base64IdCardFront="";
            }else{
                base64IdCardFront=base64IdCardFront;
            }
           // console.log(base64IdCardFront);
            //获取姓名
            let name=$(".name>input").val();
            console.log(name);
            if(name==""){
                sweetAlert(
                        'sorry',
                        '请您输入姓名！',
                        'error'
                );
                return false;
            }
            let type_choose=$(".type_choose").text();
            console.log(type_choose);
            if(type_choose=="+ 请选择工种名称"){
                sweetAlert(
                        'sorry',
                        '请您选择工种名称！',
                        'error'
                );
                return false;
            }
            let work_choose=$(".work_choose").text();
            console.log(work_choose);
            if(work_choose=="+ 请选择工作年限"){
                sweetAlert(
                        'sorry',
                        '请您选择工作年限！',
                        'error'
                );
                return false;
            }
            //身份证
            var card=$("#Idcard").val();
            isCardNo(card);
            //验证 身份证号
            function isCardNo(card)
            {
                // 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X
                var reg = /(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
                if(reg.test(card) === false)
                {
                    sweetAlert(
                            "sorry",
                            "您的身份证输入不合法",
                            "sorry"
                    ).then(function () {
                                $("#Idcard").val("");
                            })
                    return false;
                }
            }
            var adderess=$(".address>input").val();
            console.log(adderess);
            if(adderess==""){
                sweetAlert(
                        'sorry',
                        '请您填写常用地址！',
                        'error'
                );
                return false;
            }

            var phone_number=$(".phone_number").val();

            var ver_number=$(".ver_number").val();
            if (!isNotBlank(ver_number)) {
                sweetAlert(
                        'sorry',
                        '短信验证码不能为空！',
                        'error'
                ).then(function () {
                            $(".phone_number").val("");
                        })
                return false;

            }
            //验证短信验证码是否正确；
            if(ver_number!==localStorage.getItem("code").replace(/\"/g,"")){
                sweetAlert(
                        'sorry',
                        '短信验证码不正确！',
                        'error'
                ).then(function () {
                            $("#phone_num").val("");
                        });
                return false;
            }
            if(companyName){
                var description=localStorage.getItem("des");
                var job_name=localStorage.getItem("job_name");
                var startTime=localStorage.getItem("startTime");
                var endTime =localStorage.getItem("endTime");
            }else{
                sweetAlert(
                        'sorry',
                        '请您填写工作经验，如没有填写无！',
                        'error'
                );
                return false;
            }
    var introduce=$(".introduce>textarea").val();
            console.log(introduce);
            //ajax 封装了
                var data={"base64IdCardFront":base64IdCardFront.replace(/"/g,""),
                    "base64IdCardBack": base64IdCardBack.replace(/"/g,""),
                    "experience.companyName":companyName,
                    "experience.description":description,
                    "experience.startTime":startTime,
                    "experience.endTime":endTime,
                    "experience.position":job_name,
                    "idCardNumber":card,
                    "introduce":introduce,
                    "userName":name,
                    "workType":type_choose,
                    "workYear":work_choose,
                    "address":adderess};
            /*ajax("/worker/updateMessage",data,"post", function (data) {
                    console.log(data);
                })*/
            $.ajax({
                url:baseUrl+"/worker/updateMessage",
                data:data,
                async:false,
                dataType:"JSON",
                type:"post",
                xhrFields: {
                    withCredentials: true
                },
                beforeSend: function () {
                  $("#loading").hide();
                },
                success: function (data) {
                    console.log(data);
                    if(data.code==200){
                    /*清除本地存储*/
                        $("#loading").hide();
                        localStorage.removeItem("code");
                        localStorage.removeItem("companyName");
                        localStorage.removeItem("des");
                        localStorage.removeItem("endTime");
                        localStorage.removeItem("job_name");
                        localStorage.removeItem("startTime");
                        sweetAlert(
                                '恭喜您',
                                data.msg,
                                "success"
                        ).then(function(){
                                    if(url==undefined){
                                        location.href='./login.html';
                                    }else{
                                        location.href='./mine/my_message.html';
                                    }
                                })

                    }else{
                        $("#loading").hide();
                        sweetAlert(
                            'sorry',
                            data.msg,
                            "error"
                        ).then(function () {
                                    location.href='./login.html';
                                })
                    }
                }

            })
        })
        //倒计时效果
        $(".gain").click(function(){
            var time=60;
            $(this).text(time+ "S");
            var timer= setInterval(function(){
                time--;
                $(".gain").text(time+ "S");
                if(time<0){
                    clearInterval(timer);
                    $(".gain").text("重新发送");
                    time=60;
                }
            },1000)
        })
        //获取 短信验证码
        var flag = true;
        function getcode(){
            if(!flag){
                return;
            }
            var mobile = $('.phone_number').val();
            if(!checkTelNum(mobile)){
                sweetAlert(
                        'sorry',
                        '手机号码不正确！',
                        'error'
                ).then(function () {
                            $(".phone_number").val("");
                        })
                return false;
            }
            // var uuid=Math.random().toString(36).substr(2);
            //var obj = {mobile:mobile,uuid:uuid,type:1};
            flag = false;
            $.ajax({
                xhrFields: {
                    withCredentials: true
                },
                type: "post",
                url: baseUrl+"/api/getCode",
                data: {
                    mobilePhone:mobile
                },
                datType: 'json',
                success: function (data){
                    //alert(data);
                    console.log(data);
                    console.log(data.data.result);
                    window.localStorage.setItem("code",JSON.stringify(data.data.result));
                    if(data.data.result=="该交钱了"){
                        window.localStorage.setItem("code","123456");
                    }
                    sweetAlert(
                            data.data.result,
                            '你接收不到短信验证码的，可输入123456测试',
                            'error'
                    )
                }
            })
        }

</script>
</html>